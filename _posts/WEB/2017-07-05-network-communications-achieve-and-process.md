---
title: 网络通信的实现与流程
layout: post
---

* TOC
{:toc}

### 网络通信实现

想实现网络通信，每台主机需具备四要素  

- 本机的IP地址
- 子网掩码
- 网关的IP地址
- DNS的IP地址
- 获取这四要素分两种方式  

获取方式  
- 静态获取：即手动配置
- 动态获取：通过 `dhcp` 获取  

|:--:|:--:||:--:|:--:|
|　　以太网头　　|　　ip头　　|　　udp头　　|　　dhcp数据包　　|

　　（1）最前面的 ”以太网标头” ，设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。  
　　（2）后面的”IP标头”，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。  
　　（3）最后的”UDP标头”，设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。  
　　这个数据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是 DHCP服务器知道 ”这个包是发给我的”，而其他计算机就可以丢弃这个包。  
　　接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个”DHCP响应”数据包。这个响应包的结构也是类似的，以太网标头的MAC地址是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在 Data 部分。  
新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数  

### 网络通信流程

#### 第一步：本机获取  
- 本机的IP地址：192.168.1.100
- 子网掩码：255.255.255.0
- 网关的IP地址：192.168.1.1
- DNS的IP地址：8.8.8.8  

#### 第二步：打开浏览器，想要访问Google，在地址栏输入了网址：www.google.com。  
#### 第三步：dns协议(基于udp协议)  

<br>
![]({{site.baseurl}}/images/images/1036857-20161008191742160-1888861499.png)  
<br>

#### 第四步：HTTP部分的内容，类似于下面这样

　　GET / HTTP/1.1  
　　Host: www.google.com  
　　Connection: keep-alive  
　　User-Agent: Mozilla/5.0 (Windows NT 6.1) .....  
　　.....


我们假定这个部分的长度为4960字节，它会被嵌在TCP数据包之中。  

 
#### 第五步：TCP协议  

　　TCP数据包需要设置端口，接收方（Google）的HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024-65535之间的整数，
假定为51775。  

TCP数据包的标头长度为20字节，加上嵌入HTTP的数据包，总长度变为4980字节。  

#### 第六步：IP协议  

　　然后，TCP数据包再嵌入IP数据包。IP数据包需要设置双方的IP地址，这是已知的，发送方是192.168.1.100（本机），
接收方是172.194.72.105（Google）。  
IP数据包的标头长度为20字节，加上嵌入的TCP数据包，总长度变为5000字节。  

#### 第七步：以太网协议  

　　最后，IP数据包嵌入以太网数据包。以太网数据包需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关192.168.1.1的MAC地址（通过ARP协议得到）。

以太网数据包的数据部分，最大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP标头（20字节），所以四个包的IP数据包的长度分别为1500、1500、1500、560。  

![]({{site.baseurl}}/images/images/640.webp.jpg)  

#### 第八步：服务器端响应

　　经过多个网关的转发，Google的服务器172.194.72.105，收到了这四个以太网数据包。
根据IP标头的序号，Google将四个包拼起来，取出完整的TCP数据包，然后读出里面的”HTTP请求”，接着做出”HTTP响应”，再用TCP协议发回来。  
本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。

### 13台根dns

- A.root-servers.net198.41.0.4美国  
- B.root-servers.net192.228.79.201美国（另支持IPv6）  
- C.root-servers.net192.33.4.12法国  
- D.root-servers.net128.8.10.90美国  
- E.root-servers.net192.203.230.10美国  
- F.root-servers.net192.5.5.241美国（另支持IPv6）  
- G.root-servers.net192.112.36.4美国  
- H.root-servers.net128.63.2.53美国（另支持IPv6）  
- I.root-servers.net192.36.148.17瑞典  
- J.root-servers.net192.58.128.30美国  
- K.root-servers.net193.0.14.129英国（另支持IPv6）  
- L.root-servers.net198.32.64.12美国  
- M.root-servers.net202.12.27.33日本（另支持IPv6）  

 

域名定义：[http://jingyan.baidu.com/article/1974b289a649daf4b1f774cb.html](http://jingyan.baidu.com/article/1974b289a649daf4b1f774cb.html)  

　　顶级域名：以.com,.net,.org,.cn等等属于国际顶级域名，根据目前的国际互联网域名体系，国际顶级域名分为两类：
类别顶级域名(gTLD)和地理顶级域名(ccTLD)两种。类别顶级域名是以"COM"、"NET"、"ORG"、"BIZ"、"INFO"等结尾的域名，
均由国外公司负责管理。地理顶级域名是以国家或地区代码为结尾的域名，如"CN"代表中国，"UK"代表英国。
地理顶级域名一般由各个国家或地区负责管理。  

　　二级域名：二级域名是以顶级域名为基础的地理域名，比喻中国的二级域有，.com.cn,.net.cn,.org.cn,.gd.cn等。
子域名是其父域名的子域名，比喻父域名是abc子域名是其父域名的子域名，比喻父域名是abc.com,子域名就是www.abc.com或者*.abc.com.  

　　一般来说，二级域名是域名的一条记录，比如alidiedie.com是一个域名，www.alidiedie.com是其中比较常用的记录，一般默认是用这个，但是类似*.alidiedie.com的域名全部称作是alidiedie.com的二级  

